<div class="family-members-container main-div">

  <!-- Member Cards Grid -->
  <ng-container *ngIf="!selectedMember()">
    <div class="member-cards">
      <div 
        *ngFor="let member of familyMembers()" 
        class="member-card fam-btn"
        [ngStyle]="{'background': member.color || getMemberColor(member.name), 'color': '#fff'}"
        (click)="selectMember(member)"
      >
        <span style="font-size:1.2em; font-weight:600;">{{ member.name }}</span>
      </div>
      
      <!-- Add Member Card -->
      <div 
        class="member-card add-member-card fam-btn"
        (click)="openAddMemberModal()"
      >
        <i class="fa-solid fa-plus"></i>
      </div>
    </div>
    <!-- Removed old button and form below cards -->
  </ng-container>

  <!-- Add Member Modal -->
  <div *ngIf="showAddMemberForm" class="planner-modal">
    <div class="modal-backdrop" (click)="closeAddMemberModal()"></div>
    <div class="modal-content centered">
      <button class="close-x-btn" (click)="closeAddMemberModal()">âœ•</button>
      <h2 style="margin-bottom: 20px;">Add New Member</h2>
      
      <form [formGroup]="addMemberForm" (ngSubmit)="submitAddMember()" style="width: 100%; max-width: 400px;">
        <div>
          <label>Member Name</label>
          <input 
            type="text" 
            formControlName="memberName" 
            placeholder="Enter name"
            required
            class="form-input"
          >
        </div>
        
        <div class="color-picker-row" style="padding: 10px 0;">
          <label>Color:</label>
          <input 
            type="color" 
            formControlName="memberColor"
            class="color-input"
          >
        </div>
        
        <div>
          <label class="checkbox-label">
            <input type="checkbox" formControlName="isUser"> 
            <span>Is User?</span>
          </label>
        </div>
        
        <!-- Show additional fields only if "Is User" is checked -->
        <ng-container *ngIf="addMemberForm.get('isUser')?.value">
          <div class="form-divider" style="margin: 10px 0;"></div>
          
          <div>
            <label>Username</label>
            <input 
              type="text" 
              formControlName="username" 
              placeholder="Enter username"
              class="form-input"
            >
          </div>
          
          <div>
            <label>Email</label>
            <input 
              type="email" 
              formControlName="email" 
              placeholder="Enter email"
              class="form-input"
            >
          </div>
          
          <div>
            <label>Country</label>
            <select formControlName="country" class="form-input">
              <option value="">Select country</option>
              <option value="Israel (+972)">Israel (+972)</option>
              <option value="United States (+1)">United States (+1)</option>
              <option value="United Kingdom (+44)">United Kingdom (+44)</option>
              <option value="France (+33)">France (+33)</option>
              <option value="Germany (+49)">Germany (+49)</option>
              <option value="India (+91)">India (+91)</option>
              <option value="Brazil (+55)">Brazil (+55)</option>
              <option value="Russia (+7)">Russia (+7)</option>
              <option value="China (+86)">China (+86)</option>
              <option value="Japan (+81)">Japan (+81)</option>
              <option value="Nepal (+977)">Nepal (+977)</option>
            </select>
          </div>
          
          <div>
            <label>Phone</label>
            <input 
              type="tel" 
              formControlName="whatsappNumber" 
              placeholder="e.g., 0545766580"
              class="form-input"
            >
          </div>
        </ng-container>
        
        <div class="form-buttons" style="margin-top: 20px; gap: 12px;">
          <button class="save-btn-full" type="submit" [disabled]="addMemberForm.invalid">
            Save Member
          </button>
          <button class="cancel-btn-full" type="button" (click)="closeAddMemberModal()">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <div *ngIf="selectedMember()" class="tasks-display">
    <button class="back-btn " (click)="selectedMember.set(null)" style="margin-bottom:16px;">
      <i class="fa-solid fa-arrow-left"></i> all members
    </button>
   
    <div class="fe-header-row">
      <h2 class="all-tasks-h2">{{ selectedMember()?.name }} All Tasks</h2>
      <button class="add-btn-icon" (click)="openAddTaskModal()" title="Add Task">
        <span aria-hidden="true">+</span>
      </button>
    </div>
    <div class="tab-content" *ngIf="activeMemberTab === 'all'">
    <div class="planner-modal" *ngIf="showAddTaskModal">
      <div class="modal-backdrop" (click)="closeAddTaskModal()"></div>
      <div class="modal-content centered">
        <button class="close-x-btn" (click)="closeAddTaskModal()" title="Close">
          <i class="fa-solid fa-xmark"></i>
        </button>
        <h2>Add Task for {{ selectedMember()?.name }}</h2>
        <div class="task-type-buttons" style="margin-bottom: 1em;">
          <button class="fam-btn type-btn" (click)="openTaskForm('meeting')">
            <i class="fa-regular fa-calendar type-icon"></i> Meeting
          </button>
          <button class="fam-btn type-btn" (click)="openTaskForm('class')">
            <i class="fa-solid fa-graduation-cap type-icon"></i> Class
          </button>
          <button class="fam-btn type-btn" (click)="openTaskForm('shopping')">
            <i class="fa-solid fa-cart-shopping type-icon"></i> Shopping
          </button>
          <button class="fam-btn type-btn" (click)="openTaskForm('birthday')">
            <i class="fa-solid fa-gift type-icon"></i> Birthday
          </button>
          <button class="fam-btn type-btn" (click)="openTaskForm('doctor')">
            <i class="fa-solid fa-user-doctor type-icon"></i> See a Doctor
          </button>
          <button class="fam-btn type-btn" (click)="openTaskForm('other')">
            <i class="fa-regular fa-star type-icon"></i> Other
          </button>
        </div>
        <ng-container *ngIf="isFormVisible">
          <form [formGroup]="newTaskForm" (ngSubmit)="submitNewTask()">
            <h4>
              <span *ngIf="selectedTaskType === 'meeting'" class="type-icon"><i class="fa-regular fa-calendar"></i></span>
              <span *ngIf="selectedTaskType === 'class'" class="type-icon"><i class="fa-solid fa-graduation-cap"></i></span>
              <span *ngIf="selectedTaskType === 'shopping'" class="type-icon"><i class="fa-solid fa-cart-shopping"></i></span>
              <span *ngIf="selectedTaskType === 'birthday'" class="type-icon"><i class="fa-solid fa-gift"></i></span>
              <span *ngIf="selectedTaskType === 'doctor'" class="type-icon"><i class="fa-solid fa-user-doctor"></i></span>
              <span *ngIf="selectedTaskType === 'other'" class="type-icon"><i class="fa-regular fa-star"></i></span>
              Add <span [ngClass]="'type-label type-' + selectedTaskType">{{ selectedTaskType || 'Task' }}</span> for {{ selectedMember()?.name }}
            </h4>
            <input type="hidden" formControlName="type">
            <div>
              <label for="title">Title:</label>
              <input id="title" type="text" formControlName="title" required>
              <app-required-error-message *ngIf="newTaskForm.get('title')?.invalid && (newTaskForm.get('title')?.dirty || newTaskForm.get('title')?.touched || submitted)" fieldName="Title" />
            </div>
            <div>
              <label for="details">Details (optional):</label>
              <textarea id="details" formControlName="details"></textarea>
            </div>
            <ng-container *ngIf="newTaskForm.get('type')?.value === 'class'; else normalTaskFields">
              <div>
                <label for="weekday">Day of Week:</label>
                <select id="weekday" formControlName="weekday" required>
                  <option value="" disabled selected>Select day</option>
                <app-required-error-message *ngIf="newTaskForm.get('weekday')?.invalid && (newTaskForm.get('weekday')?.dirty || newTaskForm.get('weekday')?.touched || submitted) && newTaskForm.get('type')?.value === 'class'" fieldName="Day of Week" />
                  <option [ngValue]="0">Sunday</option>
                  <option [ngValue]="1">Monday</option>
                  <option [ngValue]="2">Tuesday</option>
                  <option [ngValue]="3">Wednesday</option>
                  <option [ngValue]="4">Thursday</option>
                  <option [ngValue]="5">Friday</option>
                  <option [ngValue]="6">Saturday</option>
                </select>
              </div>
              <div>
                <label for="time">Time:</label>
                <input id="time" type="time" formControlName="time" required>
                <app-required-error-message *ngIf="newTaskForm.get('time')?.invalid && (newTaskForm.get('time')?.dirty || newTaskForm.get('time')?.touched || submitted) && newTaskForm.get('type')?.value === 'class'" fieldName="Time" />
              </div>
            </ng-container>
            <ng-template #normalTaskFields>
              <div>
                <label for="date">Date/Time:</label>
                <input id="date" type="datetime-local" formControlName="date" required>
                <app-required-error-message *ngIf="newTaskForm.get('date')?.invalid && (newTaskForm.get('date')?.dirty || newTaskForm.get('date')?.touched || submitted) && newTaskForm.get('type')?.value !== 'class'" fieldName="Start Date/Time" />
              </div>
              <div>
                <label for="reminderDateTime">Reminder Date/Time:</label>
                <input id="reminderDateTime" type="datetime-local" formControlName="reminderDateTime" required>
                <app-required-error-message *ngIf="newTaskForm.get('reminderDateTime')?.invalid && (newTaskForm.get('reminderDateTime')?.dirty || newTaskForm.get('reminderDateTime')?.touched || submitted) && newTaskForm.get('type')?.value !== 'class'" fieldName="Reminder Date/Time" />
              </div>
              
            </ng-template>
            <button class="fam-btn" type="submit" [disabled]="newTaskForm.invalid" color="primary">Save Task</button>
            <button class="fam-btn" type="button" (click)="isFormVisible = false; selectedTaskType = null">Cancel</button>
          </form>
        </ng-container>
        
        <div style="margin-top: 30px; width: 100%;">
          <app-weekly-improvement 
            class="weekly-improvement" 
            [memberColor]="selectedMember()?.color || getMemberColor(selectedMember()?.name || '')"
            (saveAsTask)="onSaveAsTask($event)">
          </app-weekly-improvement>
        </div>
      </div>
    </div>
      <ul class="member-tasks" *ngIf="selectedMemberTasks().length > 0; else noTasks">
        <li class="task" *ngFor="let task of selectedMemberTasks()"
          [ngStyle]="{'border': '3px solid ' + getMemberColor(task.memberName), 'background': 'none'}"
          [class.optimistic-task]="task._optimistic">
          <div class="task-content">
            <div class="task-member-name"><strong>{{ task.memberName }}</strong></div>
            <strong>{{ task.title }}</strong>
            <span *ngIf="task._optimistic" class="optimistic">Saving...</span>
            <p>{{ task.details }}</p>
            <small>{{ task.date | friendlyDateTime }}</small>
          </div>
          <button (click)="deleteTask(task.id!)" class="delete-button fam-btn " color="primary">Delete</button>
        </li>
      </ul>
      <ng-template #noTasks>
        <p>No tasks found for this member.</p>
      </ng-template>
    </div>
    <div class="tab-content" *ngIf="activeMemberTab === 'add'">
      <div class="task-type-buttons">
        <button class="fam-btn type-btn" (click)="openTaskForm('meeting')">
          <i class="fa-regular fa-calendar type-icon"></i> Meeting
        </button>
        <button class="fam-btn type-btn" (click)="openTaskForm('class')">
          <i class="fa-solid fa-graduation-cap type-icon"></i> Class
        </button>
        <button class="fam-btn type-btn" (click)="openTaskForm('shopping')">
          <i class="fa-solid fa-cart-shopping type-icon"></i> Shopping
        </button>
        <button class="fam-btn type-btn" (click)="openTaskForm('birthday')">
          <i class="fa-solid fa-gift type-icon"></i> Birthday
        </button>
        <button class="fam-btn type-btn" (click)="openTaskForm('doctor')">
          <i class="fa-solid fa-user-doctor type-icon"></i> See a Doctor
        </button>
        <button class="fam-btn type-btn" (click)="openTaskForm('other')">
          <i class="fa-regular fa-star type-icon"></i> Other
        </button>
      </div>
      <app-weekly-improvement (saveAsTask)="onSaveAsTask($event)"></app-weekly-improvement>
      <div *ngIf="isFormVisible" class="add-task-form">
        <form [formGroup]="newTaskForm" (ngSubmit)="submitNewTask()">
          <h4>
            <span *ngIf="selectedTaskType === 'meeting'" class="type-icon"><i class="fa-regular fa-calendar"></i></span>
            <span *ngIf="selectedTaskType === 'class'" class="type-icon"><i class="fa-solid fa-graduation-cap"></i></span>
            <span *ngIf="selectedTaskType === 'shopping'" class="type-icon"><i class="fa-solid fa-cart-shopping"></i></span>
            <span *ngIf="selectedTaskType === 'birthday'" class="type-icon"><i class="fa-solid fa-gift"></i></span>
            <span *ngIf="selectedTaskType === 'doctor'" class="type-icon"><i class="fa-solid fa-user-doctor"></i></span>
            <span *ngIf="selectedTaskType === 'other'" class="type-icon"><i class="fa-regular fa-star"></i></span>
            Add <span [ngClass]="'type-label type-' + selectedTaskType">{{ selectedTaskType || 'Task' }}</span> for {{ selectedMember()?.name }}
          </h4>
          <input type="hidden" formControlName="type">
          <div>
            <label for="title">Title:</label>
            <input id="title" type="text" formControlName="title" required>
            <app-required-error-message *ngIf="newTaskForm.get('title')?.invalid && (newTaskForm.get('title')?.dirty || newTaskForm.get('title')?.touched || submitted)" fieldName="Title" />
          </div>
          <div>
            <label for="details">Details (optional):</label>
            <textarea id="details" formControlName="details"></textarea>
          </div>
          <ng-container *ngIf="newTaskForm.get('type')?.value === 'class'; else normalTaskFields">
            <div>
              <label for="weekday">Day of Week:</label>
              <select id="weekday" formControlName="weekday" required>
                <option value="" disabled selected>Select day</option>
              <app-required-error-message *ngIf="newTaskForm.get('weekday')?.invalid && (newTaskForm.get('weekday')?.dirty || newTaskForm.get('weekday')?.touched || submitted) && newTaskForm.get('type')?.value === 'class'" fieldName="Day of Week" />
                <option [ngValue]="0">Sunday</option>
                <option [ngValue]="1">Monday</option>
                <option [ngValue]="2">Tuesday</option>
                <option [ngValue]="3">Wednesday</option>
                <option [ngValue]="4">Thursday</option>
                <option [ngValue]="5">Friday</option>
                <option [ngValue]="6">Saturday</option>
              </select>
            </div>
            <div>
              <label for="time">Time:</label>
              <input id="time" type="time" formControlName="time" required>
              <app-required-error-message *ngIf="newTaskForm.get('time')?.invalid && (newTaskForm.get('time')?.dirty || newTaskForm.get('time')?.touched || submitted) && newTaskForm.get('type')?.value === 'class'" fieldName="Time" />
            </div>
          </ng-container>
          <ng-template #normalTaskFields>
            <div>
              <label for="date">Date/Time:</label>
              <input id="date" type="datetime-local" formControlName="date" required>
              <app-required-error-message *ngIf="newTaskForm.get('date')?.invalid && (newTaskForm.get('date')?.dirty || newTaskForm.get('date')?.touched || submitted) && newTaskForm.get('type')?.value !== 'class'" fieldName="Start Date/Time" />
            </div>
            <div>
              <label for="reminderDateTime">Reminder Date/Time:</label>
              <input id="reminderDateTime" type="datetime-local" formControlName="reminderDateTime" required>
              <app-required-error-message *ngIf="newTaskForm.get('reminderDateTime')?.invalid && (newTaskForm.get('reminderDateTime')?.dirty || newTaskForm.get('reminderDateTime')?.touched || submitted) && newTaskForm.get('type')?.value !== 'class'" fieldName="Reminder Date/Time" />
            </div>
           
          </ng-template>
          <button class="fam-btn" type="submit" [disabled]="newTaskForm.invalid" color="primary">Save Task</button>
          <button class="fam-btn " type="button" (click)="toggleFormVisibility()">Cancel</button>
        </form>
      </div>
    </div>
  </div>
</div>