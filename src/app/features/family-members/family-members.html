<div class="family-members-container main-div">

  <!-- Member Cards Grid -->
  <ng-container *ngIf="!selectedMember()">
    <div class="member-cards">
      <div 
        *ngFor="let member of familyMembers()" 
        class="member-card fam-btn"
        [ngStyle]="{'background': getMemberColor(member.name), 'color': '#fff'}"
        (click)="selectMember(member)"
      >
        <span style="font-size:1.2em; font-weight:600;">{{ member.name }}</span>
      </div>
    </div>
    <ng-container *ngIf="isMainUser()">
      <button class="fam-btn" (click)="showAddMemberForm = !showAddMemberForm">Add Member</button>
      <div *ngIf="showAddMemberForm" class="add-member-form">
        <form [formGroup]="addMemberForm" (ngSubmit)="submitAddMember()">
          <label for="memberName">Member Name:</label>
          <input id="memberName" type="text" formControlName="memberName" required>
          <label>
            <input type="checkbox" formControlName="isUser"> Is this member a user?
          </label>
          <button class="fam-btn" type="submit" [disabled]="addMemberForm.invalid">Save Member</button>
        </form>
      </div>
    </ng-container>
  </ng-container>

  <div *ngIf="selectedMember()" class="tasks-display">
    <button class="back-btn fam-btn" (click)="selectedMember.set(null)" style="margin-bottom:16px;">
      <i class="fa-solid fa-arrow-left"></i> Back
    </button>
    <h3>Tasks for {{ selectedMember()?.name }}</h3>
    <div class="member-tabs-inner">
      <button class="fam-btn" (click)="activeMemberTab = activeMemberTab === 'add' ? 'all' : 'add'">
        {{ activeMemberTab === 'add' ? 'Show All Tasks' : 'Add Task' }}
      </button>
    </div>
    <div *ngIf="activeMemberTab === 'add'">
      <div class="task-type-buttons">
        <button class="fam-btn type-btn" (click)="openTaskForm('meeting')">
          <i class="fa-regular fa-calendar type-icon"></i> Meeting
        </button>
        <button class="fam-btn type-btn" (click)="openTaskForm('class')">
          <i class="fa-solid fa-graduation-cap type-icon"></i> Class
        </button>
        <button class="fam-btn type-btn" (click)="openTaskForm('shopping')">
          <i class="fa-solid fa-cart-shopping type-icon"></i> Shopping
        </button>
        <button class="fam-btn type-btn" (click)="openTaskForm('birthday')">
          <i class="fa-solid fa-gift type-icon"></i> Birthday
        </button>
        <button class="fam-btn type-btn" (click)="openTaskForm('doctor')">
          <i class="fa-solid fa-user-doctor type-icon"></i> See a Doctor
        </button>
        <button class="fam-btn type-btn" (click)="openTaskForm('other')">
          <i class="fa-regular fa-star type-icon"></i> Other
        </button>
      </div>
      <app-weekly-improvement (suggestAsTask)="onSuggestAsTask($event)"></app-weekly-improvement>
      <div *ngIf="isFormVisible" class="add-task-form">
        <form [formGroup]="newTaskForm" (ngSubmit)="submitNewTask()">
          <h4>
            <span *ngIf="selectedTaskType === 'meeting'" class="type-icon"><i class="fa-regular fa-calendar"></i></span>
            <span *ngIf="selectedTaskType === 'class'" class="type-icon"><i class="fa-solid fa-graduation-cap"></i></span>
            <span *ngIf="selectedTaskType === 'shopping'" class="type-icon"><i class="fa-solid fa-cart-shopping"></i></span>
            <span *ngIf="selectedTaskType === 'birthday'" class="type-icon"><i class="fa-solid fa-gift"></i></span>
            <span *ngIf="selectedTaskType === 'doctor'" class="type-icon"><i class="fa-solid fa-user-doctor"></i></span>
            <span *ngIf="selectedTaskType === 'other'" class="type-icon"><i class="fa-regular fa-star"></i></span>
            Add <span [ngClass]="'type-label type-' + selectedTaskType">{{ selectedTaskType || 'Task' }}</span> for {{ selectedMember()?.name }}
          </h4>
          <input type="hidden" formControlName="type">
          <div>
            <label for="title">Title:</label>
            <input id="title" type="text" formControlName="title" required>
          </div>
          <div>
            <label for="details">Details (optional):</label>
            <textarea id="details" formControlName="details"></textarea>
          </div>
          <ng-container *ngIf="newTaskForm.get('type')?.value === 'class'; else normalTaskFields">
            <div>
              <label for="weekday">Day of Week:</label>
              <select id="weekday" formControlName="weekday" required>
                <option [ngValue]="0">Sunday</option>
                <option [ngValue]="1">Monday</option>
                <option [ngValue]="2">Tuesday</option>
                <option [ngValue]="3">Wednesday</option>
                <option [ngValue]="4">Thursday</option>
                <option [ngValue]="5">Friday</option>
                <option [ngValue]="6">Saturday</option>
              </select>
            </div>
            <div>
              <label for="time">Time:</label>
              <input id="time" type="time" formControlName="time" required>
            </div>
          </ng-container>
          <ng-template #normalTaskFields>
            <div>
              <label for="date">Start Date/Time:</label>
              <input id="date" type="datetime-local" formControlName="date" required>
            </div>
            <div>
              <label for="reminderDateTime">Reminder Date/Time:</label>
              <input id="reminderDateTime" type="datetime-local" formControlName="reminderDateTime" required>
            </div>
            <div>
              <label for="end">End Date/Time (Optional):</label>
              <input id="end" type="datetime-local" formControlName="end">
            </div>
          </ng-template>
          <button class="fam-btn" type="submit" [disabled]="newTaskForm.invalid" color="primary">Save Task</button>
          <button class="fam-btn cancel-btn" type="button" (click)="toggleFormVisibility()">Cancel</button>
        </form>
      </div>
    </div>
    <div *ngIf="activeMemberTab === 'all'">
      <ul class="member-tasks" *ngIf="selectedMemberTasks().length > 0; else noTasks">
        <li class="task" *ngFor="let task of selectedMemberTasks()"
          [ngStyle]="{'border': '3px solid ' + getMemberColor(task.memberName), 'background': 'none'}"
          [class.optimistic-task]="task._optimistic">
          <div class="task-content">
            <div class="task-member-name"><strong>{{ task.memberName }}</strong></div>
            <strong>{{ task.title }}</strong>
            <span *ngIf="task._optimistic" class="optimistic">Saving...</span>
            <p>{{ task.details }}</p>
            <small>{{ task.date | friendlyDateTime }}</small>
          </div>
          <button (click)="deleteTask(task.id!)" class="delete-button fam-btn " color="primary">Delete</button>
        </li>
      </ul>
      <ng-template #noTasks>
        <p>No tasks found for this member.</p>
      </ng-template>
    </div>
  </div>
</div>